# 部署功能测试指南

本文档提供了完整的部署功能测试方案，包括问题诊断和解决方案。

## 🔍 **当前问题分析**

### **问题1: SSH认证失败**
```
root@100.64.0.172's password: 权限被拒绝
命令执行失败 (退出码: 255)
```

**原因分析:**
- SSH服务器认证配置问题
- 用户名/密码不正确
- SSH密钥配置错误
- 网络连接或防火墙问题

### **问题2: 数据库记录丢失**
```
PrismaClientKnownRequestError: No record was found for an update
```

**原因分析:**
- 部署记录在执行过程中被删除
- 异步操作中的数据竞争
- 数据库连接问题

## ✅ **已实施的修复**

### **1. 数据库记录保护**

#### **使用upsert替代update**
```typescript
// 修复前 ❌
await prisma.deployment.update({
  where: { id: deploymentId },
  data: { status: 'success' }
})

// 修复后 ✅
await prisma.deployment.upsert({
  where: { id: deploymentId },
  update: { status: 'success' },
  create: {
    id: deploymentId,
    // ... 完整的记录数据
  }
})
```

### **2. SSH错误诊断增强**

#### **详细错误信息**
```typescript
if (errorMessage.includes('255')) {
  this.log('💡 SSH连接失败可能的原因:')
  this.log('   - SSH服务未运行或端口不正确')
  this.log('   - 认证信息错误（用户名/密码/密钥）')
  this.log('   - 网络连接问题或防火墙阻止')
  this.log('   - 目标主机不可达')
}
```

### **3. 本地测试环境**

#### **本地主机配置**
- 主机名: localhost
- 认证方式: local
- 无需SSH认证
- 适合功能测试

## 🧪 **测试方案**

### **方案1: 本地部署测试**

#### **步骤1: 配置本地主机**
1. 进入主机管理页面
2. 添加新主机:
   - 名称: 本地测试主机
   - 主机名: localhost
   - 端口: 22
   - 认证方式: local
   - 用户名: 当前用户

#### **步骤2: 创建测试项目**
1. 进入项目管理页面
2. 创建新项目:
   - 名称: 本地测试项目
   - 仓库地址: (可选)
   - 构建脚本: `echo "构建完成"`
   - 部署脚本: `echo "部署完成"`
   - 目标主机: 本地测试主机

#### **步骤3: 创建部署任务**
1. 进入部署管理页面
2. 创建新部署:
   - 项目: 本地测试项目
   - 环境: dev
   - 状态: 已审批

#### **步骤4: 执行部署测试**
1. 点击"开始部署"
2. 观察状态变化
3. 查看部署日志
4. 验证结果

### **方案2: SSH连接测试**

#### **使用测试脚本**
```bash
node scripts/test-ssh-connection.js
```

#### **手动SSH测试**
```bash
# 测试SSH连接
ssh -o ConnectTimeout=10 -o BatchMode=yes root@100.64.0.172 "echo 'SSH连接成功'"

# 检查SSH服务
telnet 100.64.0.172 22

# 测试网络连通性
ping 100.64.0.172
```

### **方案3: 逐步诊断**

#### **1. 检查主机配置**
- 验证IP地址和端口
- 确认用户名和认证方式
- 测试SSH密钥或密码

#### **2. 网络连接测试**
- ping目标主机
- telnet端口连接
- 检查防火墙设置

#### **3. SSH服务检查**
- 确认SSH服务运行状态
- 检查SSH配置文件
- 查看SSH服务日志

## 🔧 **故障排查指南**

### **SSH连接问题**

#### **错误: 权限被拒绝**
```
解决方案:
1. 检查用户名和密码
2. 验证SSH密钥配置
3. 确认用户SSH权限
4. 检查SSH服务配置
```

#### **错误: 连接超时**
```
解决方案:
1. 检查网络连接
2. 验证IP地址和端口
3. 检查防火墙设置
4. 确认SSH服务运行
```

#### **错误: 主机不可达**
```
解决方案:
1. ping测试网络连通性
2. 检查路由配置
3. 验证DNS解析
4. 确认主机在线状态
```

### **数据库问题**

#### **错误: 记录不存在**
```
解决方案:
1. 使用upsert替代update
2. 添加记录存在性检查
3. 改进错误处理逻辑
4. 增加事务保护
```

#### **错误: 连接失败**
```
解决方案:
1. 检查数据库服务状态
2. 验证连接配置
3. 检查网络连接
4. 查看数据库日志
```

## 🚀 **推荐测试流程**

### **阶段1: 本地功能测试**
1. 配置本地测试环境
2. 创建简单的测试项目
3. 执行本地部署测试
4. 验证基本功能正常

### **阶段2: SSH连接测试**
1. 配置远程测试主机
2. 测试SSH连接
3. 验证认证配置
4. 测试文件传输

### **阶段3: 完整部署测试**
1. 配置真实项目
2. 执行完整部署流程
3. 监控部署过程
4. 验证部署结果

### **阶段4: 错误处理测试**
1. 模拟各种错误情况
2. 验证错误处理逻辑
3. 检查日志记录
4. 确认状态更新

## 📊 **测试检查清单**

### **基础功能**
- [ ] 页面正常加载
- [ ] 数据正确显示
- [ ] 状态实时更新
- [ ] 中文提示正常

### **部署流程**
- [ ] 部署任务创建
- [ ] 部署状态变化
- [ ] 日志实时显示
- [ ] 错误正确处理

### **SSH连接**
- [ ] 主机配置正确
- [ ] SSH连接成功
- [ ] 文件传输正常
- [ ] 远程命令执行

### **错误处理**
- [ ] 连接失败处理
- [ ] 数据库错误处理
- [ ] 状态正确更新
- [ ] 错误信息清晰

## 💡 **最佳实践建议**

### **1. 渐进式测试**
- 从本地测试开始
- 逐步增加复杂性
- 验证每个环节

### **2. 详细日志记录**
- 记录所有关键步骤
- 包含错误详细信息
- 便于问题诊断

### **3. 错误处理完善**
- 预期所有可能错误
- 提供清晰错误信息
- 确保状态一致性

### **4. 用户体验优化**
- 实时状态反馈
- 中文友好提示
- 操作指导清晰

通过这个测试指南，您可以系统性地验证部署功能，诊断和解决问题，确保系统稳定可靠。
