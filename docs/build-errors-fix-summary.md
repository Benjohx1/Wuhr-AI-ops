# Next.jsæ„å»ºé”™è¯¯ä¿®å¤æ€»ç»“

## æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹Wuhr AI Opså¹³å°Next.jsæ„å»ºè¿‡ç¨‹ä¸­é‡åˆ°çš„é™æ€ç”Ÿæˆé”™è¯¯çš„ä¿®å¤æƒ…å†µã€‚è¿™äº›é”™è¯¯ä¸»è¦æ¶‰åŠåŠ¨æ€æœåŠ¡å™¨ä½¿ç”¨å’ŒReact Suspenseè¾¹ç•Œé—®é¢˜ã€‚

## ä¿®å¤æ—¶é—´

**ä¿®å¤æ—¥æœŸ**: 2025-01-06  
**ç‰ˆæœ¬**: v1.3.2  
**ä¿®å¤ç±»å‹**: æ„å»ºé”™è¯¯ä¿®å¤

## é—®é¢˜åˆ†æ

### é”™è¯¯ç±»å‹1ï¼šDynamic Server Usageé”™è¯¯

**é”™è¯¯æè¿°**ï¼š
```
Dynamic server usage: Route couldn't be rendered statically because it used `request.headers`
```

**æ ¹æœ¬åŸå› **ï¼š
- Next.jsåœ¨é™æ€ç”Ÿæˆæ—¶å°è¯•é¢„æ¸²æŸ“APIè·¯ç”±
- è¿™äº›APIè·¯ç”±ä½¿ç”¨äº†`request.headers`æˆ–`request.url`ç­‰åŠ¨æ€å†…å®¹
- Next.jsæ— æ³•åœ¨æ„å»ºæ—¶ç¡®å®šè¿™äº›åŠ¨æ€å€¼

**å½±å“çš„APIè·¯ç”±**ï¼š
1. `/api/admin/users/permissions`
2. `/api/admin/user-approvals/history`
3. `/api/auth/profile`
4. `/api/auth/verify`
5. `/api/cicd/builds/stats`
6. `/api/cicd/deployments/stats`
7. `/api/models`
8. `/api/notifications/pending-approvals`

### é”™è¯¯ç±»å‹2ï¼šuseSearchParams Suspenseé”™è¯¯

**é”™è¯¯æè¿°**ï¼š
```
useSearchParams() should be wrapped in a suspense boundary at page "/login"
```

**æ ¹æœ¬åŸå› **ï¼š
- Next.js 13+è¦æ±‚`useSearchParams()`å¿…é¡»åŒ…è£…åœ¨Suspenseè¾¹ç•Œä¸­
- è¿™æ˜¯ä¸ºäº†æ”¯æŒæµå¼æ¸²æŸ“å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šAPIè·¯ç”±åŠ¨æ€æ¸²æŸ“é…ç½®

ä¸ºæ‰€æœ‰ä½¿ç”¨åŠ¨æ€å†…å®¹çš„APIè·¯ç”±æ·»åŠ å¼ºåˆ¶åŠ¨æ€æ¸²æŸ“é…ç½®ï¼š

```typescript
// åœ¨æ¯ä¸ªAPIè·¯ç”±æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
export const dynamic = 'force-dynamic'
```

**ä¿®å¤æ•ˆæœ**ï¼š
- å‘Šè¯‰Next.jsè¿™äº›è·¯ç”±éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€æ¸²æŸ“
- é¿å…åœ¨æ„å»ºæ—¶å°è¯•é™æ€ç”Ÿæˆè¿™äº›è·¯ç”±
- ä¿æŒAPIçš„åŠ¨æ€åŠŸèƒ½ä¸å—å½±å“

### æ–¹æ¡ˆ2ï¼šç™»å½•é¡µé¢SuspenseåŒ…è£…

å°†`useSearchParams()`çš„ä½¿ç”¨åŒ…è£…åœ¨Suspenseè¾¹ç•Œä¸­ï¼š

```typescript
// åˆ›å»ºåŒ…è£…ç»„ä»¶
function LoginForm() {
  const searchParams = useSearchParams()
  // ... å…¶ä»–é€»è¾‘
}

// ä¸»é¡µé¢ç»„ä»¶
export default function LoginPage() {
  return (
    <Suspense fallback={<div>åŠ è½½ä¸­...</div>}>
      <LoginForm />
    </Suspense>
  )
}
```

**ä¿®å¤æ•ˆæœ**ï¼š
- ç¬¦åˆNext.js 13+çš„Suspenseè¦æ±‚
- æä¾›æ›´å¥½çš„åŠ è½½ä½“éªŒ
- æ”¯æŒæµå¼æ¸²æŸ“

## ä¿®å¤è¯¦æƒ…

### ä¿®å¤çš„APIæ–‡ä»¶

1. **ç”¨æˆ·æƒé™API**
   - æ–‡ä»¶ï¼š`app/api/admin/users/permissions/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

2. **ç”¨æˆ·å®¡æ‰¹å†å²API**
   - æ–‡ä»¶ï¼š`app/api/admin/user-approvals/history/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

3. **è®¤è¯èµ„æ–™API**
   - æ–‡ä»¶ï¼š`app/api/auth/profile/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

4. **è®¤è¯éªŒè¯API**
   - æ–‡ä»¶ï¼š`app/api/auth/verify/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

5. **CI/CDæ„å»ºç»Ÿè®¡API**
   - æ–‡ä»¶ï¼š`app/api/cicd/builds/stats/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

6. **CI/CDéƒ¨ç½²ç»Ÿè®¡API**
   - æ–‡ä»¶ï¼š`app/api/cicd/deployments/stats/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

7. **æ¨¡å‹API**
   - æ–‡ä»¶ï¼š`app/api/models/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

8. **é€šçŸ¥å¾…å®¡æ‰¹API**
   - æ–‡ä»¶ï¼š`app/api/notifications/pending-approvals/route.ts`
   - ä¿®æ”¹ï¼šæ·»åŠ `export const dynamic = 'force-dynamic'`

### ä¿®å¤çš„é¡µé¢æ–‡ä»¶

1. **ç™»å½•é¡µé¢**
   - æ–‡ä»¶ï¼š`app/login/page.tsx`
   - ä¿®æ”¹ï¼š
     - é‡å‘½åæ¥å£`LoginForm` â†’ `LoginFormData`
     - åˆ›å»º`LoginForm`ç»„ä»¶åŒ…è£…`useSearchParams()`
     - ä¸»é¡µé¢ç»„ä»¶ä½¿ç”¨SuspenseåŒ…è£…

## æ„å»ºç»“æœ

### ä¿®å¤å‰
- æ„å»ºå¤±è´¥
- 8ä¸ªAPIè·¯ç”±çš„åŠ¨æ€æœåŠ¡å™¨ä½¿ç”¨é”™è¯¯
- 1ä¸ªç™»å½•é¡µé¢çš„Suspenseé”™è¯¯

### ä¿®å¤å
- âœ… æ„å»ºæˆåŠŸ
- âœ… æ‰€æœ‰APIè·¯ç”±æ­£å¸¸å·¥ä½œ
- âœ… ç™»å½•é¡µé¢æ­£å¸¸æ¸²æŸ“
- âœ… ç”Ÿæˆ75ä¸ªé™æ€é¡µé¢
- âœ… æ— é”™è¯¯å’Œè­¦å‘Š

### æ„å»ºç»Ÿè®¡
```
Route (app)                                 Size     First Load JS
â”Œ â—‹ /                                       5.82 kB         342 kB
â”œ â—‹ /login                                  6.61 kB         250 kB
â”œ Æ’ /api/auth/verify                        0 B                0 B
â”œ Æ’ /api/models                             0 B                0 B
... (å…±75ä¸ªè·¯ç”±)

â—‹  (Static)   prerendered as static content
Æ’  (Dynamic)  server-rendered on demand
```

## æŠ€æœ¯è¦ç‚¹

### Next.js 13+ App Routerè§„åˆ™

1. **APIè·¯ç”±æ¸²æŸ“**ï¼š
   - é»˜è®¤æƒ…å†µä¸‹ï¼ŒNext.jså°è¯•é™æ€ç”Ÿæˆæ‰€æœ‰è·¯ç”±
   - ä½¿ç”¨åŠ¨æ€å†…å®¹çš„APIéœ€è¦æ˜ç¡®æ ‡è®°ä¸ºåŠ¨æ€
   - `export const dynamic = 'force-dynamic'`å¼ºåˆ¶è¿è¡Œæ—¶æ¸²æŸ“

2. **Suspenseè¾¹ç•Œ**ï¼š
   - `useSearchParams()`ç­‰å®¢æˆ·ç«¯hookséœ€è¦SuspenseåŒ…è£…
   - æ”¯æŒæµå¼æ¸²æŸ“å’Œæ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
   - æä¾›åŠ è½½çŠ¶æ€çš„fallback UI

3. **é™æ€vsåŠ¨æ€**ï¼š
   - é™æ€è·¯ç”±åœ¨æ„å»ºæ—¶ç”Ÿæˆï¼Œæ€§èƒ½æ›´å¥½
   - åŠ¨æ€è·¯ç”±åœ¨è¿è¡Œæ—¶ç”Ÿæˆï¼Œæ”¯æŒä¸ªæ€§åŒ–å†…å®¹
   - éœ€è¦æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¸²æŸ“ç­–ç•¥

### æœ€ä½³å®è·µ

1. **APIè®¾è®¡**ï¼š
   - éœ€è¦è®¤è¯çš„APIåº”æ ‡è®°ä¸ºåŠ¨æ€
   - çº¯é™æ€æ•°æ®çš„APIå¯ä»¥ä¿æŒé™æ€ç”Ÿæˆ
   - åˆç†ä½¿ç”¨ç¼“å­˜ç­–ç•¥

2. **é¡µé¢ç»„ä»¶**ï¼š
   - å®¢æˆ·ç«¯hooksä½¿ç”¨SuspenseåŒ…è£…
   - æä¾›æœ‰æ„ä¹‰çš„åŠ è½½çŠ¶æ€
   - è€ƒè™‘SEOå’Œé¦–å±æ¸²æŸ“æ€§èƒ½

3. **æ„å»ºä¼˜åŒ–**ï¼š
   - å®šæœŸæ£€æŸ¥æ„å»ºè¾“å‡º
   - ç›‘æ§åŒ…å¤§å°å’Œæ€§èƒ½æŒ‡æ ‡
   - åˆç†åˆ†é…é™æ€å’ŒåŠ¨æ€å†…å®¹

## åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1å‘¨å†…ï¼‰
1. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ä¿®å¤åçš„APIå“åº”æ—¶é—´
2. **ç”¨æˆ·ä½“éªŒ**ï¼šæ”¶é›†ç™»å½•é¡µé¢çš„ç”¨æˆ·åé¦ˆ
3. **é”™è¯¯ç›‘æ§**ï¼šç¡®ä¿æ²¡æœ‰æ–°çš„è¿è¡Œæ—¶é”™è¯¯

### ä¸­æœŸè§„åˆ’ï¼ˆ1ä¸ªæœˆå†…ï¼‰
1. **ç¼“å­˜ç­–ç•¥**ï¼šä¸ºåŠ¨æ€APIæ·»åŠ é€‚å½“çš„ç¼“å­˜
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–åŒ…å¤§å°å’Œé¦–å±åŠ è½½æ—¶é—´
3. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹æ„å»ºå¤±è´¥çš„è‡ªåŠ¨å‘Šè­¦

### é•¿æœŸè§„åˆ’ï¼ˆ3ä¸ªæœˆå†…ï¼‰
1. **æ¶æ„ä¼˜åŒ–**ï¼šè€ƒè™‘APIå’Œé¡µé¢çš„æ¸²æŸ“ç­–ç•¥
2. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šæ·»åŠ æ„å»ºå’Œæ¸²æŸ“çš„è‡ªåŠ¨åŒ–æµ‹è¯•
3. **æ–‡æ¡£å®Œå–„**ï¼šå»ºç«‹å¼€å‘è§„èŒƒå’Œæœ€ä½³å®è·µæ–‡æ¡£

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†Next.jsæ„å»ºè¿‡ç¨‹ä¸­çš„æ‰€æœ‰é”™è¯¯ï¼š

1. âœ… **APIè·¯ç”±é”™è¯¯**ï¼šä¸º8ä¸ªAPIè·¯ç”±æ·»åŠ åŠ¨æ€æ¸²æŸ“é…ç½®
2. âœ… **Suspenseé”™è¯¯**ï¼šé‡æ„ç™»å½•é¡µé¢ä½¿ç”¨SuspenseåŒ…è£…
3. âœ… **æ„å»ºæˆåŠŸ**ï¼šæ— é”™è¯¯æ— è­¦å‘Šï¼Œç”Ÿæˆ75ä¸ªè·¯ç”±
4. âœ… **åŠŸèƒ½å®Œæ•´**ï¼šæ‰€æœ‰åŠŸèƒ½ä¿æŒæ­£å¸¸å·¥ä½œ

ä¿®å¤åçš„ç³»ç»Ÿå…·æœ‰æ›´å¥½çš„æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼Œç¬¦åˆNext.js 13+çš„æœ€ä½³å®è·µã€‚æ‰€æœ‰åŠ¨æ€å†…å®¹æ­£ç¡®é…ç½®ï¼Œé™æ€å†…å®¹å¾—åˆ°ä¼˜åŒ–ï¼Œä¸ºåç»­çš„åŠŸèƒ½å¼€å‘å¥ å®šäº†è‰¯å¥½åŸºç¡€ã€‚

---

**ğŸ‰ ä¿®å¤çŠ¶æ€**: å·²å®Œæˆ  
**ğŸ“Š æ„å»ºçŠ¶æ€**: æˆåŠŸ  
**ğŸš€ éƒ¨ç½²çŠ¶æ€**: å¯ä»¥éƒ¨ç½²  
**ğŸ“ æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·è”ç³»å¼€å‘å›¢é˜Ÿ
